# TCP拥塞控制 #

​	TCP协议让每个发送方根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率。

> 问题1：一个TCP发送方如何限制它向其连接发送流量的速率？
>
> ​	运行在发送方的TCP拥塞控制机制跟踪一个称为**拥塞窗口(cwnd)**的变量，通过调节cwnd的值，发送方调节它向连接发送数据的速率。
>
>
>
> 问题2：一个TCP发送方如何感知从它到目的地之间的路径上存在的拥塞？
>
> ​	一个TCP发送方的“丢包事件”定义为要么出现超时，要么收到来自接收方的3个冗余ACK，发送方就认为在发送方到接收方的路径上出现了拥塞的指示。TCP使用确认来增大它的拥塞窗口长度，即当在网络中传输的报文段被成功的交付到目的地，则增加拥塞窗口大小和发送方速率，因此是**自计时**的。
>
>
>
> 问题3：TCP发送方如何确定它应当发送的速率(原则)？
>
> -  一个丢失的报文段意味着拥塞，因此当丢失报文段时，应当降低TCP发送方的速率。
> - 一个确认报文段指示该网络正在向接收方交付发送方的报文段，因此当对先前未确认报文段的确认到达时，能够增加发送方的速率。
> - 带宽探测。探测拥塞开始时发送方的发送速率。
>
>
>
> 问题4：当发送方感知到端到端的拥塞时，采用何种算法来改变其发送速率？
>
> ​	采用TCP拥塞控制算法，其由三部分组成：慢启动；拥塞避免；快速恢复。慢启动和拥塞避免是TCP的强制部分，两者的差异在于对收到的ACK做出反应时增加cwnd的方式。快速恢复是推荐部分，对TCP发送方不是必需的。

## 原理

拥塞控制是一种用来调整运输层TCP每个传输轮次发送分组数量多少（单次发送几个MSS最大报文段大小的分组，即cwnd= n*MSS）的算法。      

###1.流量控制与拥塞控制的区别与联系

- 拥塞控制所要做的都有一个前提，就是**网络能够承受现有的网络负荷**。
- 拥塞控制是一个**全局性的**过程，涉及**到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素**。 
- 流量控制往往指在给定的发送端和接收端之间的**点对点通信量的控制**。 
- 流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收。

举例:
1.宽带速率1Gb/s，网络只有两台机器，从一台主机传送数据到另一台，这需要流量控制，以保证接收方能正常接收数据。
2.宽带速率1Gb/s，网络中有成千上万台机器，几万台主机发送到另外几万台，这需要拥塞控制，不然网络会瘫痪。所以折中一下，在连接数较少的情况下可能需要流量控制，配合拥塞控制。


###2.拥塞控制算法

发送方维持一个叫做**拥塞窗口 cwnd (congestion window)的状态变量**。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。

发送方控制拥塞窗口的**原则**是：**只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数**。 

####(1)慢开始(启动)算法

1. 慢启动过程

	- 在主机刚刚开始发送报文段时可先设置拥塞窗口 cwnd = 1，即设置为一个最大报文段 MSS 的数值。
	- 在每收到一个对新的报文段的确认后，将拥塞窗口加 1，即增加一个 MSS 的数值。
	- 用这样的方法逐步增大发送端的拥塞窗口 cwnd，可以使分组注入到网络的速率更加合理。

2. 图解

![](http://onh97xzo0.bkt.clouddn.com/3-18.PNG)

- 使用慢开始算法后，每经过一个传输轮次，拥塞窗口 cwnd 就加倍。 
- 一个传输轮次所经历的时间其实就是往返时间 RTT。
- “传输轮次”更加强调：**把拥塞窗口 cwnd 所允许发送的报文段都连续发送出去，并收到了对已发送的最后一个字节的确认。**
- 例如，拥塞窗口 cwnd = 4，这时的往返时间 RTT 就是发送方连续发送 4 个报文段，并收到这 4 个报文段的确认，总共经历的时间。

**何时结束这种指数的增长？**

 - <font color=red> 如果存在一个由超时指示的丢包事件(拥塞)，TCP发送方将cwnd设置为1并重新开始慢启动过程。并且ssthresh(慢启动阈值)设置为cwnd/2，即当检测到拥塞时将ssthresh设置为拥塞窗口值的一半。</font>
 - <font color=red> 第二种方式是直接和ssthresh的值相关联。当 cwnd >= ssthresh 时，停止使用慢启动算法而改用拥塞避免算法。 当进入拥塞避免算法时，TCP更加谨慎的增加cwnd。</font>
 - <font color=red>如果检测3个冗余ACK，TCP则执行一次快速重传并进入快速恢复阶段。</font>

####(2)拥塞避免算法

​	拥塞避免算法的**思路**是让拥塞窗口 cwnd 缓慢地增大，即**每经过一个往返时间 RTT** 就把发送方的拥塞窗口 cwnd 加 1，而不是加倍，使拥塞窗口 cwnd 按线性规律缓慢增长。**“拥塞避免”是在拥塞避免阶段把拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞。** 

**何时结束拥塞避免算法线性增长？**

- <font color=red>当出现超时时，TCP拥塞避免算法的行为与慢启动一致，cwnd设置为1个MSS，当出现丢包事件时，ssthresh得值被更新为cwnd的一半。</font>
- <font color=red>当丢包事件由一个三个冗余ACK事件触发时，TCP将cwnd减半，并且当收到3个冗余ACK时，将ssythresh的值记录为cwnd的一半。接下来进入快速恢复阶段。</font>

####(3) 快速恢复

​	在快速恢复中，对于引起TCP进入快速恢复状态的缺失报文段，对收到的每个冗余的ACK，cwnd的值增加一个MSS。最终，当对丢失报文段的一个ACK到达时，TCP在降低cwnd后进入拥塞避免状态。如果出现超时事件，快速恢复在执行如同慢启动和拥塞避免中相同的动作后，迁移至慢启动状态；当出现丢包事件时，cwnd的值被设置为1个MSS，并且ssthresh的值被设置为cwnd的一半。

###3.几点说明


####(1)当网络出现拥塞时

- 无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞（其根据就是没有按时收到确认），就要把慢开始门限 ssthresh 设置为出现拥塞时的发送方窗口值的一半（但不能小于2）。
- 然后把拥塞窗口 cwnd 重新设置为 1，执行慢开始算法。
- 这样做的目的就是要迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕。 

举例：

![](http://onh97xzo0.bkt.clouddn.com/3-19.PNG)

拥塞控制:

- **乘法减小(MD)(慢启动、拥塞避免)**

  “乘法减小“是指不论在慢开始阶段还是拥塞避免阶段，只要出现一次超时（即出现一次网络拥塞），就把慢开始门限值 ssthresh 设置为当前的拥塞窗口值乘以 0.5。
  当网络频繁出现拥塞时，ssthresh 值就下降得很快，以大大减少注入到网络中的分组数。 

- **加法增大(AI)(拥塞避免)**

	“加法增大”是指执行拥塞避免算法后，在收到对所有报文段的确认后（即经过一个往返时间），就把拥塞窗口 cwnd增加一个 MSS 大小，使拥塞窗口缓慢增大，以防止网络过早出现拥塞。 

####(2)快速重传与恢复

#####(a)快速重传

- 快重传算法首先要求接收方每收到一个失序的报文段后就立即发出重复确认。这样做可以让发送方及早知道有报文段没有到达接收方。 
- 发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段。 

![](http://onh97xzo0.bkt.clouddn.com/3-20.PNG)

#####(b)快速恢复

当发送端收到连续三个重复的确认时，就执行“乘法减小”算法，慢启动阈值 变为ssthresh=cwnd/2, cwnd=ssthresh，转为拥塞避免算法。

![](http://onh97xzo0.bkt.clouddn.com/3-21.PNG)

###4.拥塞控制状态转移

![](http://onh97xzo0.bkt.clouddn.com/3-22.PNG)