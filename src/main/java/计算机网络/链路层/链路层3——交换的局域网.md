# 交换的局域网

## 一、链路层寻址和ARP

​	主机和路由器具有链路层地址，同样也具有网络层地址。地址解析协议ARP提供了将IP地址转换为链路层地址的机制。

### 1.MAC地址

​	**主机或路由器**拥有链路层地址，实际上是它们的**适配器(网络接口)具有链路层地址**。因此，具有多个网络接口的主机或路由器将具有与之相关联的多个链路层地址。重要的是**链路层交换机不具有与它们的接口相关联的链路层地址**，因为链路层交换机的任务是在主机和路由器之间承载数据报，交换机透明地执行该项任务，主机或路由器不必明确地该帧寻址到其间的交换机。下图说明了这种情况。

![](http://pbku1z6p0.bkt.clouddn.com/5-3.png?imageMogr2/auto-orient/thumbnail/x300/blur/1x0/quality/75|imageslim)

​								图1    链路层交换机的接口不具有MAC地址

​	链路层地址称为LAN地址、物理地址或MAC地址。对于多数局域网，MAC地址长度为6字节，共有2的48次方个可能的MAC地址。这些6个字节地址通常用十六进制表示法，地址的每个字节被表示为一对十六进制数。**MAC地址的有趣性质是没有两块适配器具有相同的地址。**

​	**MAC地址与IP地址的比较**：适配器的MAC地址具有扁平结构，而且不论适配器到哪里用都不会变化。IP地址具有层次结构(一个网络部分和一个主机部分)，而且当主机移动时，主机的IP地址需要改变，即改变它所连接到的网络。

​	当某适配器要向某些目的适配器发送一个帧时，发送适配器将目的适配器的MAC地址插入到该帧中，并将该帧发送到局域网上。一台交换机可能将一个入帧广播到它的所有接口。因此，一个适配器可以接收一个并非向他寻址的帧。当适配器接收到一个帧时，将检查该帧的目的MAC地址是否与它自己的MAC地址匹配。如果匹配，该适配器提取出封装的数据报，并将该数据报沿协议栈向上传递。如果不匹配，该适配器丢弃该帧，而不会向上传递该网络层数据报。

​	有时发送适配器的确要让局域网上所有其他适配器来接受和处理他打算发送的帧，这时，发送适配器在该帧的目的地址字段中插入一个特殊的**MAC广播地址，即FF-FF-FF-FF-FF-FF**。

### 2.地址解析协议

​	因为存在网络层地址(IP)和链路层地址(MAC地址)，所以需要在它们之间进行转换。对于因特网来说，是地址解析协议的任务。

![](http://pbku1z6p0.bkt.clouddn.com/5-5.png?imageMogr2/auto-orient/thumbnail/x300/blur/1x0/quality/75|imageslim)

​							图2 局域网上的每个接口具有一个IP地址和一个MAC地址

​	**ARP与DNS的区别**：ARP将一个IP地址解析为一个MAC地址。很多方面与DNS类似，DNS将主机名解析为IP地址。两者的重要区别是，**DNS为在因特网中任何地方的主机解析主机名，而ARP只为在同一个子网上的主机和路由器接口接卸IP地址。**

​	**ARP工作原理**：

![](http://pbku1z6p0.bkt.clouddn.com/5-4.png)

​									图3 在主机222.222.222.220中的一个可能的ARP表

​	<u>每台主机或路由器在其内存中具有一个ARP表，这张表包含IP地址到MAC地址的映射关系</u>。如图3所示是在主机222.222.222.220中可能看到的ARP表内容。该ARP表也包括一个**寿命TTL值**，指示了从表中删除每个映射的时

间。	

​	假设主机222.222.222.220要发送一个数据报，该数据报要IP寻址到本子网上另一台主机或者路由器。发送主机需要获取给定IP地址的目的主机的MAC地址。①如果发送方的ARP表中具有该目的节点的表项，这个任务很容易完成。②如果没有，假设222.222.222.220向222.222.222.222发送数据报。这种情况下，发送方用ARP协议解析这个目的地址。首先，发送方构造一个称为**ARP分组**的特殊分组。一个ARP分组有几个字段，包括发送和接收IP地址及MAC地址。**ARP查询分组和响应分组具有相同的格式。ARP查询分组的目的是询问子网上所有其他主机和路由器，以确定对应于要解析的IP地址的那个MAC地址。**	

​	因此，222.222.222.220向它的适配器传递一个ARP查询分组，并且指示适配器应该用MAC广播地址来发送这个分组。适配器在链路层帧中封装了这个ARP分组，用广播地址作为帧的目的地址，并将该帧传输进子网中。包含该ARP查询的帧能被子网上的所有其他适配器接收到，并且（由于广播地址）每个适配器都把在该帧中的ARP分组向上传递给ARP模块。这些ARP模块中的每一个检查它的IP地址是否与ARP分组中的目的IP地址相匹配。与之匹配的一个给查询主机发送回一个带有所希望映射的响应ARP分组。然后查询主机222.222.222.220能够更新它的ARP表，并发送它的IP数据报，该数据报封装在一个链路层帧中，并且该帧的目的MAC地址是对先前ARP请求进行响应的主机或路由器的MAC地址。

​	**注意**：查询ARP报文是在广播帧中发送的，而响应ARP报文是在一个标准帧(单播)中发送的；ARP即插即用，ARP表是自动建立的，不需要手动配置。

### 3.发送数据报到子网之外

​	现在考虑当子网中的某主机要向子网之外的主机发送网路层数据报的情况。如图4所示。

​                              							![](http://pbku1z6p0.bkt.clouddn.com/5-6.png)

​												图4 由一台路由器互联的两个子网

​	**注意**：每台主机仅有一个IP地址和一个适配器。一台路由器的每个接口都有一个IP地址，每个接口也有一个ARP模块和一个适配器。每个适配器都有自己的MAC地址。

​	具体的发送过程参见P311-312。**发送主机适配器发送的帧的目的地址是路由器的MAC地址(E6-E9-00-17-BB-4B)。**

## 二、以太网

​	以太网是目前为止最流行的有线局域网技术。

### 1.以太网帧的结构

​								![](http://pbku1z6p0.bkt.clouddn.com/5-7.png)

​										              图5 以太网帧的结构

-  数据字段(46-1500字节)。这个字段承载了IP数据报。以太网的最大传输单元MTU是1500字节。这意味着如果IP数据报超过了1500字节，则主机必须将该数据报分片。数据字段的最小长度是46字节。
- 目的地址(6字节)。该字段包含目的适配器的MAC地址。
- 源地址(6字节)。这个字段包含了传输该帧到局域网上的适配器的MAC地址。
- 类型字段(2字节)。类型字段允许以太网复用多种网络层协议，并且主机能够使用除了IP之外的其他网络层协议。
- CRC(4字节)。**循环冗余校验**字段目的是使得接收方适配器检测帧中是否引入了差错。
- 前同步码(8字节)。

​	**特点**：​	①所有的以太网技术都向网络层提供无连接服务。②以太网技术都向网络层提供不可靠服务。

### 2.以太网技术

​	在以太网技术中，以太网帧的格式保持不变。

## 三、链路层交换机

​	**交换机的任务是接收入链路层帧并将它转发到出链路。**交换机自身对子网中的主机和路由器是透明的，在某主机或路由器向另一主机或路由器寻址一个帧时，顺利将该帧发送到局域网，并不知道某交换机将会接收该帧并将它转发到另一个节点。交换机输出接口设有缓存，以防止帧到达该接口的速率超过该接口的链路容量。

### 1.交换机转发和过滤

​	**过滤**是决定一个帧应该转发到某个接口还是应当将其丢弃的交换机功能。**转发**是决定一个帧应该被导向哪个接口，并把该帧移动到那些接口的交换机功能。交换机的过滤和转发基于**交换机表**完成。交换机表上的一个表项包含①一个MAC地址；②通向该MAC地址的交换机接口；③表项放置在表中的时间。如下图6 所示。

![](http://pbku1z6p0.bkt.clouddn.com/5-8.png)

​											图6 交换机表的一部分

​	**交换机转发分组是基于MAC地址的，而路由器转发分组是基于IP地址的。并且交换机表和路由器的转发表的构造方式有很大差别。**

​	过滤和转发的工作原理：

​	假设目的地址为DD-DD-DD-DD-DD-DD的帧从交换机接口x到达，交换机用MAC地址DD-DD-DD-DD-DD-DD索引他的交换机表，可能有以下三种情况：

- 表中无DD-DD-DD-DD-DD-DD的表项。这时，交换机向除x接口外的所有接口前面的输出缓存转发该帧的副本。即如果没有对应目的地址的表项，交换机广播该帧。
- 表中有一个表项将DD-DD-DD-DD-DD-DD与接口x联系起来。这时，该帧从包括适配器DD-DD-DD-DD-DD-DD的局域网网段到来。无需将该帧转发到任何其他接口，交换机直接丢弃该帧执行过滤功能。
- 表中有一个表项将DD-DD-DD-DD-DD-DD与接口y(不等于x)联系起来。这时，该帧需要被转发至与接口y相连的局域网网段。交换机通过将该帧放到接口y前面的输出缓存中完成转发功能。

### 2.自学习

​	交换机的表是自动、动态和自治地建立的，即没有来自网络管理员或来自配置协议的任何干预，也就是自学习的。这种能力通过如下的方式实现：

- 交换机表初始为空。
- 对于在每个接口接收到的每个入帧，该交换机在其表中存储：①在该帧源地址字段中的MAC地址；②该帧到达的接口；③当时时间。交换机以这种方式在其表中记录了发送节点所在的局域网网段。如果在局域网中的每个节点最终都发送了一个帧，则每个节点最终将在这张表中留有记录。
- 如果在一段时间后(老化期)，交换机没有收到以该地址作为源地址的帧，就在表中删除这个地址。

​	**交换机是即插即用的设备，不需要任何网络管理员或用户的干预。交换机也是全双工的，任何交换机接口能够同时发送和接收。**

### 3.链路层交换机的性质

- **消除碰撞**。在使用交换机构建的局域网中，没有因碰撞而浪费的带宽。交换机缓存帧并且不会在网段上同时传输多余一个帧。交换机的最大聚合带宽是该交换机所有接口速率之和。因此，交换机提供了比使用广播链路的局域网高得多的性能改善。
- **异质的链路**。交换机将链路彼此隔离，因此局域网上的不同链路能够以不同的速率运行并且能够在不同的媒体上运行。
- **管理**。交换机易于进行网络管理。

### 4.交换机与路由器的比较

​	路由器是使用网络层地址转发分组的存储转发分组交换机，链路层交换机是使用MAC地址转发分组的存储转发分组交换机。交换机是第二层的分组交换机，路由器是第三层的分组交换机。

(1) **交换机的优缺点**

​	①交换机即插即用；②交换机能够具有相对高的分组过滤和转发速率，交换机必须处理高至第二层的帧，而路由器必须处理高至第三层的数据报；③为了防止广播帧的循环，交换网络的活跃拓扑限制为一颗生成树；④一个大型交换网络将要求在主机和路由器中有大的ARP表，这将生成可观的ARP流量和处理量；⑤交换机对于广播风暴并不提供任何保护措施。

(2) **路由器的优缺点**

​	①分组不会通过路由器循环；②分组不会被限制在一颗生成树上，并可以使用源和目的地之间的最佳路径；③路由器没有生成树限制，所以他们允许以丰富的拓扑结构构建因特网；④路由器对第二层的广播风暴提供了防火墙保护；⑤非即插即用；⑥路由器对每个分组的处理时间通常比交换机长，因为路由器必须处理高达第三层的字段。

(3) 何时使用交换机或路由器

​	①对于由几百台主机组成的小网络通常有几个局域网网段，使用交换机；②对于由几千台主机组成的更大网络，通常在网络中还包括路由器。

## 四、虚拟局域网(VLAN)

​	现代机构的局域网通常配置为等级结构，每个工作部门有自己的交换局域网，经过一个交换机等级结构与其他工作部门的交换局域网互联。这种配置有如下的缺点：**①缺乏流量隔离。②交换机的无效使用。③管理用户**。

​	以上这些问题能够通过支持**虚拟局域网**VLAN的交换机来处理。支持VLAN的交换机允许经一个单一的物理局域网基础设施定义多个虚拟局域网。在一个VLAN内的主机彼此通信。在一个基于端口的VLAN中，交换机的端口由网络管理员划分为组，每个组构成一个VLAN，在每个VLAN中的端口形成一个广播域(即来自一个端口的广播流量仅能到达该组中的其他端口)。如下图7所示。

![](http://pbku1z6p0.bkt.clouddn.com/5-9.png?imageMogr2/auto-orient/thumbnail/x300/blur/1x0/quality/75|imageslim)

​												 图7 配置了两个VLAN的单台交换机



