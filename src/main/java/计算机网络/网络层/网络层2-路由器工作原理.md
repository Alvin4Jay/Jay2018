# 路由器工作原理

​	实际将一个分组从一台路由器的入链路转发到适当的出链路。路由器结构如下：

![](http://pbku1z6p0.bkt.clouddn.com/4-2.png?imageMogr2/auto-orient/thumbnail/x250/blur/1x0/quality/75|imageslim)

- 输入端口。执行的功能：①执行将一条输入的物理链路与路由器相连接的物理层功能。②执行需要与位于入链路远端的数据链路层交互的数据链路层功能。③在输入端口完成查找功能(用于分组转发)。控制分组(如携带路由选择协议信息的分组)从输入端口转发到路由选择处理器。
- 交换结构。将路由器的输入端口和输出端口相连接，该结构包含在路由器内部，是一个网络路由器中的网络。
- 输出端口。存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组。
- 路由选择处理器。执行路由选择协议，维护路由选择表以及连接的链路状态信息，并为路由器计算转发表。

​	一台路由器的输入端口、输出端口和交换结构共同实现了**转发**功能，并且总是用硬件实现，转发功能有时称路由器转发平面。路由器控制平面(执行路由选择协议、管理等功能)通常用软件实现并在路由选择处理器上执行。

## 一、输入端口

![](http://pbku1z6p0.bkt.clouddn.com/4-3.png)

​                  											输入端口处理

​	输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层。在输入端口中同时执行查找功能，使用转发表查找输出端口，使得到达的分组将能通过交换结构转发到输出端口。一旦通过查找确定了某分组的输出端口，则该分组就能够发送进入交换结构。如果来自其他输入端口的分组当前正在使用该交换结构，一个分组可能会在进入交换结构时被暂时阻塞。因此，一个被阻塞的分组必须要在输入端口处排队，并等待稍后被及时调度以通过交换结构。

## 二、交换结构

​	交换结构位于一台路由器的核心部位。交换的方式有许多种，如下所示：

![](http://pbku1z6p0.bkt.clouddn.com/4-4.png)

- 经过内存交换。不能同时转发两个分组。
- 经过总线交换。一次只有一个分组能够跨越总线。
- 经互联网络交换。纵横式网络能够并行转发多个分组。如果来自两个不同输入端口的两个分组其目的地为相同的输出端口，则一个分组必须在输入端等待，因为某一时刻经给定总线仅有一个分组能够发送。

## 三、输出端口

​	输出端口处理取出存放在输出端口内存中的分组并将其发送到输出链路上，包括选择和取出排队的分组进行传输，执行所需的链路层和物理层传输功能。

![](http://pbku1z6p0.bkt.clouddn.com/4-5.png)

## 四、排队情况

​	排队的位置和程度(输入端口处排队或输出端口处排队)取决于流量负载、交换结构的相对速率和线路速率。随着队列的增长，路由器的缓存空间将会耗尽，在无内存可用于存储到达的分组时将会出现丢包。

### 1.输出端口排队

![](http://pbku1z6p0.bkt.clouddn.com/4-6.png?imageMogr2/auto-orient/thumbnail/x450/blur/1x0/quality/75|imageslim)

​	在交换结构交换速率匹配输入端的速率时，若有多个分组向同一输出端口转发，则分组需要在输出端口排队。

### 2.输入端口排队

![](http://pbku1z6p0.bkt.clouddn.com/4-7.png?imageMogr2/auto-orient/thumbnail/x450/blur/1x0/quality/75|imageslim)

​	在交换结构交换速度不匹配输入端分组的到达速度，则分组在输入端排队等待。

## 五、路由选择控制平面

​	路由器控制平面(执行路由选择协议、管理等功能)通常用软件实现并在路由选择处理器上执行。